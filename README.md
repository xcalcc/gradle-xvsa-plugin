# XVSA Gradle Plugin

## Getting started

Latest version of xvsa-gradle-plugin is `1.0`

Group : `io.xc5.plugin`

### Description / Features
The xvsa gradle plugin uses Xcalibyte scanner to scan gradle project.

The plugin can generate intermediate files as input files for XCALIBYTE SCANNER

Or directly run XCALIBYTE SCANNER to generate vulnerability report

## Using XVSA gradle plugin

   * Supported gradle version (>=2.2)
   * Using the plugin DSL 
       ```
          plugins {
            ...
          }
       ```
 
### 1. Change your build.gradle file

   * Using legacy plugin application:
     - **Groovy**
        - **build.gradle**
          ```
          buildscript {
            // do not put below with exists repositories/dependencies block
            repositories {
              mavenLocal()
            }
            dependencies {
              classpath group: 'io.xc5.plugin',
              name: 'xvsa',
              version: '1.0'
            }
          }
          
          allprojects {
              apply plugin: "io.xc5.plugin.gradle"
          }
          
          ```
      - **Kotline (build.gradle.kts)**
        ```
        // put the buildscript to the top, combined with exits buildscript block
        buildscript {
            repositories {
                mavenLocal()
            }
        
            dependencies {
                classpath("io.xc5.plugin:xvsa:1.0")
            }
        
        }
        // apply plugin, put at the bottom
        allprojects {
            apply(plugin = "io.xc5.plugin.gradle")
        }

        ```

### 2. Scan project with xvsa plugin

   ``` shell
   # to make sure all compiler appied with debug option
   ./gradlew clean [--info]
   ./gradlew xvsa -PXVSA_HOME=<XVSA_HOME_DIR> \
                  [-PXVSA_GRADLE_OUTPUT=<OUTPUT_DIR>] \ 
                  [-PXVSA_SRC_LIST=<SRCLISTFILE>] \
                  [-PXVSA_JFE_OPT=<...Options....>] \
  	              [-PXVSA_LIB_GEN=true]  \
  	              [-PXVSA_JFE_SKIP=true]  \
  	              [-PXVSA_LIB_JAR_FILTER=<...Prefixes for jar names...>] \
                  [--info]
   ```

   The `XVSA_LIB_GEN` is a control over whether generate V-Tables for each library (dependency).  
   The `XVSA_JFE_SKIP` is an option to skip invoking jfe in the plugin, thus allowing remotely running jfe, perhaps on a client-server scenario.

   If you want to ignore any failures use
   ``` shell
   ./gradlew clean [--info]
   ./gradlew xvsa -PXVSA_HOME=<XVSA_HOME_DIR> [-PXVSA_GRADLE_OUTPUT=<OUTPUT_DIR>] [-PXVSA_LIIB_GEN=true] -PXVSA_IGNORE_ERROR=true --continue [--info]
   ```

## Development

### Build xvsa gradle plugin

we have two ways to build our package
1. build project, we can get jar package, then upload to local maven repo dir
    
  ``` shell
    # cd to current dir
    ./gradlew build
  ```

### install plugin package to local maven repo

we have two ways to install our package, from source code or from jar
1. from source code
  ``` shell
    # cd to current dir
    # upload plugin archives, upload to maven local repo 
    ./gradlew publishToMavenLocal
  ```

2. from jar package and pom file
  ``` shell
    # cd to current dir
    # build jar from source, jar will located at build/libs
    ./gradlew jar
    # generate pom file, pom file will located at build/publications/pluginMaven
    ./gradlew generatePomFileForPluginMavenPublication
    # parse information from the pom file that generated by previous, fill into command-line
    mvn install:install-file -DgroupId=<your_group_name> -DartifactId=<your_artifact_name> -Dversion=<version> -Dfile=<path_to_your_jar_file> -Dpackaging=jar -DgeneratePom=true
  ```

  

## Check Result and triage
* Output files
  The output files are located at XVSA_GRADLE_OUTPUT specified by command line or
   by default at ${project.buildDir}/target if not set
  
  Intermediate files end with .o
* Triage
  Run gradlew with:
  
  ./gradew xvsa ....... --info
  
  

## Issues and Solution
* **Issue 1:** some project may not allow to apply with plugin "java", for example projects
applied with plugin "java-platform", or projects do not contain java code, add below example 
code to ignore those projects
    ```
    allprojects { project ->
            // skip generic Java setup for the few projects that have no Java code whatsoever
            switch (project.name) {
                    case 'cast':
                    case 'smoke_main':
                    case 'xlator_test':
                    case 'com.ibm.wala-repository':
                    case ~/.*_feature/:
                            return
            }
    
            apply plugin: "io.xc5.plugin.gradle"
            apply from: "${project.rootDir}/xvsa.gradle"
    }
    ```
* **Issue 2:** Out of memory
    ```
    org.gradle.parallel = false
    ```
* **Issue 3:** Gradle version < 2.2

    ***Step 1***: Edit: gradle/wrapper/gradle-wrapper.properties
    ```
    Change Line:
    distributionUrl=http\://services.gradle.org/distributions/gradle-1.7-bin.zip
    To or greater
    distributionUrl=http\://services.gradle.org/distributions/gradle-2.2-bin.zip
    
    ```
    ***Step 2***: If met with failure "Could not find method mavenRepo() for arguments", Edit build.gradle
    ```
    Change following pattern:
    -      mavenRepo name: 'jboss-nexus', url: "http://repository.jboss.org/nexus/content/groups/public/"
    +      maven {
    +        url "http://repository.jboss.org/nexus/content/groups/public/"
    +      }

* **Issue 4:** Duplicate task name

    ***Error msg example 1:***

    ```
    * What whent wrong:
    A problem occurred evaluating XX project 'proj_XX'.
    > Cannot add task 'YY' as a task with that name already exists.
    ```
    ***Fix method***: Find the user-defined the task name 'YY' definition, add **"overwrite: true"** as below
    ```Goovy
    task YY(type: Javadoc) {
      ....
    }
    ->
    task YY(type: Javadoc, overwrite: true) {
      ....
    }
    ```
    ***Error msg example 2:***
    ```
    * What went wrong:
    A problem occurred evaluating XX project 'proj_XX'.
    > Failed to apply plugin [id 'org.gradle.java']
       > Cannot add task 'YY' as a task with that name already exists.
    ```
    ***Fix method***: it may caused by user add task 'YY' before apply xc5 plugin.
    Move below code before user task 'YY'.
    ```Goovy
    allprojects {
       apply plugin: "io.xc5.plugin.gradle"
    }
    ```
    Also change user task 'YY' with **overwrite: true**
## Tips
* User Defined extension, if do not want to use property
  * **Goovy**
    ```
    xvsa {
             xvsaHome  = "<XVSA tool Absolute path>"    // [required]
             outputDir = "<Output Absolute path>"       // [optional] [default: ${project.buildDir}/target"]
             jfeArgs   = ["-allow-phantom-refs=true"]   // [optional]
             jvmArgs   = ["-Xms512m", "-Xmx5120m" ]     // [optional]
         }
    ```
  * **Kotlin**
  ```
    allprojects {
                     apply(plugin = "io.xc5.plugin.gradle")
                     configure<io.xc5.plugin.gradle.XvsaExtension> {
                        xvsaHome   = "<XVSA tool Absolute path>"                     // [required]
                        outputDir  = "<Output Absolute path>"                        // [optional] [default: ${project.buildDir}/target"]
                        jfeArgs    = listOf("XX1", "XX2").toMutableList()            // [optional]
                        jvmArgs    = listOf("-Xms512m", "-Xmx5120m").toMutableList() // [optional]
                     }
                 }
  ```
